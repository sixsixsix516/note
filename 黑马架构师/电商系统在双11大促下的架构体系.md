# 电商系统在双11大促下的架构体系



### 中台解决问题

- 重复功能建设和维护带来重复投资
- 烟囱式建设造成系统壁垒、数据孤岛
- 业务沉淀促进可持续发展
- 大中台小前台快速响应市场的需要



#### 上层业务

大中台，小前台的前台



#### 业务中台

业务中台基于公共服务的沉淀，需要收敛一些基础的业务服务。如商品、订单、会员、库存、财务、结算等。

可靠性要求高、很少修改、稳定性强



#### 数据中台

数据平台可以理解为数据库、数据在哪个平台上？

数据仓库类比为报表、许多数据放在一起变成了仓库

贴近上层业务，带有业务属性，通过数据驱动业务



#### 技术中台 

与业务无关的基础沉淀

- 基础架构
- 服务治理
- 监控
- 持续集成
- 自动化测试
- 中间件



#### 运维中台

​	系统运维相关的信息，硬件，机房



### 面临挑战

#### 考量维度

- 高性能：快速访问体验
- 高可用：网站服务7*24正常访问
- 可伸缩：硬件弹性增加/减少能力（快速扩容与释放
- 扩展性：方便的增加/减少新的功能/模块（迭代与服务降级）
- 安全性：安全访问和数据加密，安全存储等策略
- 敏捷性：快速应对突发情况的能力（灾备等）



#### 内部瓶颈

调优就是找瓶颈 然后去解决, 一个系统抓他的短板

- 木桶效应：水管最细的地方决定流量，水桶最低的地方决定容量（QPS压测调优）
- CPU：序列化和反序列化、高频日志输出、大量反射、大量线程的应用
- 内存：使用内存的中间件或服务、如redis、jvm大量对象堆积内存的应用
- 网络带宽：大流量高并发环境下，造成网络拥堵
- 磁盘IO：文件上传下载，数据库频繁读写、不合理或大批量的日志输出
- 数据库连接数：应用服务器连接池大批扩容，警惕底层数据库、Redis等连接数瓶颈



#### 外部服务

外部系统不可靠情况，该怎么办？

- 短信： 外部短信延迟与送达率问题。可以搭建短信平台，多家渠道做路由和切换分流（短信平台架构）
- 支付：银行支付与回调延迟，搭建支付中心，对接多个支付渠道
- 快递对接：快递100
- 外部云存储：云存储文件访问，活动时流量是否扩容？
- CDN：外部静态文件访问提速服务





### 订单中心

---



#### 订单状态后使用mq传送给当前平台，如果保证有序性？

**RabbitMQ：队列级别保证有序性**

Exchange类型 fanout广播 direct直连 topic 

单消费者消费一个队列可严格保障顺序性，同一个订单发送到同一个队列即可保证顺序

**Kafka：分区保证顺序性**

单个消费者存在性能问题，所以单个消费者取出来后，做一个二次分发操作，放在多个线程，内存队列等处理



#### 过期订单

实现方式

**1. 延迟队列**

原理：每下一单，放入一个订单元素并实现getDelay方法，返回失效剩余时间。当失效时，就可以从队列中获取到。启用线程池对数据监听，一旦捕获失效订单，取出之后，调用取消逻辑处理

**优点**

- 基于JVM内存，效率高，任务触发事件延迟低

**缺点**

- 存在JVM内存中，服务器重启后，数据丢失
- 依赖代码硬编码，集群扩展麻烦
- 依赖JVM内存，数据太多，容易出现OOM
- 需要代码实现，多线程处理业务，复杂度较高
- 多线程处理时，数据频繁等待和唤醒，多了无畏的竞争



**2. 消息队列实现**

原理：设置两个队列，每下一单放一条进延迟队列，设定过期时间。消息一旦过期，获取并放入工作队列，由consumer获取，唤起超时处理逻辑

**优点**

- 可以随时在队列移除，实现实时取消订单，及时回复订单占用的资源
- 消息存储在mq中，不占用应用服务器资源
- 异步化处理，一旦处理能力不足，consumer集群可以很方便的扩容

**缺点**

- 可能会导致消息大量堆积
- mq服务器一旦故障重启后，持久化队列过期时间会被重新计算，造成精度不足
- 死信队列可能会导致监控系统频繁预警



**3. redis实现**

原理：

利用redis的notify-keyspace-events，该选项默认为空，改为Ex开启过期时间，配置消息监听。每下一单在redis中放置一个key，并设置过期时间。

**优点**

- 消息都存储在redis中，不占用应用内存
- 外部redis存储，应用宕机不会丢失数据
- 做集群扩展相当方便
- 依赖redis超时，时间准确度高

**缺点**

- 订单量大时，每一单都要存储redis内存，需要大量redis服务器资源



#### 支付中心

每个支付方要求请求不一样，大体流程一样

 **重复支付**

解决方案

1. 前端：监听到用户支付成功后，不让用户再点击支付
2. 后端：发现不同通道下的支付成功回调，抛消息队列或记录日志

**回调延迟**

解决方案：手动查询下





### 营销中心

购物车使用装饰器模式

**价格分摊**

满减或平台卷等优惠，涉及到金额的分摊，出现精度问题

解决方案

将误差放到金额最大的明细

**库存管理**

普通商品直接借助数据库锁实现，一般分为乐观锁和悲观锁

悲观锁：select时带forupdate

乐观锁：在最后执行库存扣减操作时，将事务开始前获取的库存数量导入到SQL语句当作where条件，如果数量相等，则成功修改。否则就可能出现库存信息已被其他事务修改，则应该放弃执行，重试处理



### 技术中台

**数据库优化**

大促前的预备阶段

- 在大促前梳理耗时查询业务，对关键业务压测

- 开启mysql的慢查询优化

  

**缓存优化**

热点数据预加载

**缓存细粒度化**

失效只失效一部分

**多级缓存**

浏览器缓存、CDN、nginx、应用、redis、db

频繁交互业务用Lua脚本实现

**分流限流**

**业务分流**

采用新机器入口

**终端分流**

**nginx限流**

**网关限流**

**服务降级**

- 页面降级

  将不重要的页面屏蔽，不可进入

- 微服务降级

  关闭一些接口的调用

- 快速熔断

  抛异常、返回NULL、调用Fallback处理逻辑返回备选方法，备选数据





### 安全性

- DDos，Arp, 脚本攻击

- 实名制
- 必要地方增加验证码





### 运维中台

**做好灾备**

**应用级监控**

​	主动监控：日志或消息队列形式打点输出，定时汇报（日志平台追踪课题）

​	被动监控：添加监控接口，监控系统定时请求确认可用性



**业务监控**

对具体业务点做监控处理，如订单量、登陆量、注册量，某些页面的访问量等关键点采用异步消息方式推送到监控中心，监控中心针对特定队列的数据做统计和展示



**客服一线反馈**



### 资源盘点

**网络设施扩容**

**硬件资源盘点**

**容器盘点**



### 其他准备

**流量预估**

**资源预估**

**压测准备**











 





